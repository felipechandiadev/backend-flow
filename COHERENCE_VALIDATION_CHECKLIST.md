# Backend Coherence Validation Checklist

Use this checklist to verify that all backend services have been properly refactored to:
1. âœ… Use `TransactionsService.createTransaction()` as central entry point
2. âœ… Automatically generate `LedgerEntry` (asientos)
3. âœ… Enforce validation gates (V1-V10)
4. âœ… Maintain audit trail
5. âœ… Never bypass the accounting pipeline

---

## Architecture Rules

### Rule 1: Single Entry Point for Transactions
- âŒ **BAD**: Service creates `Transaction` directly via `transactionRepository.save()`
- âœ… **GOOD**: Service calls `TransactionsService.createTransaction(dto)`

### Rule 2: Automatic Ledger Entry Generation
- âŒ **BAD**: Transaction created but no `LedgerEntry` generated
- âœ… **GOOD**: `LedgerEntry` auto-generated by `TransactionsService.createTransaction()`

### Rule 3: Validation Gate Enforcement
- âŒ **BAD**: No validations performed (V1-V10 skipped)
- âœ… **GOOD**: All V1-V10 validations enforced and rejections logged

### Rule 4: Metadata Used Effectively
- âŒ **BAD**: Metadata flags created but never consumed
- âœ… **GOOD**: Metadata used in `AccountingRulesService.matchRulesForTransaction()`

### Rule 5: DocumentNumber Generation Centralized
- âŒ **BAD**: Each service generates its own `buildDocumentNumber()`
- âœ… **GOOD**: All use `TransactionsService.generateDocumentNumber()`

### Rule 6: Error Rollback
- âŒ **BAD**: Transaction saved but ledger generation fails (orphaned)
- âœ… **GOOD**: Atomic transaction: if ledger fails, all rollback

---

## Service Compliance Checklist

### âœ… CapitalContributionsService
**Refactoring Status**: COMPLETED

- [x] Removed `transactionRepository.save()` direct calls
- [x] Removed `buildDocumentNumber()` method
- [x] Removed `metadata.capitalContribution` flag creation
- [x] Added `TransactionsService` injection
- [x] Added `CreateCapitalContributionDto.toCreateTransactionDto()` conversion
- [x] Delegates to `TransactionsService.createTransaction()`
- [x] Expected: PAYMENT_IN transaction + 2 asientos + V1-V7 validation

**Verification Command**:
```bash
# Check: No direct transactionRepository.save()
grep -n "transactionRepository.save" backend/src/modules/capital-contributions/application/capital-contributions.service.ts
# Result: SHOULD BE EMPTY

# Check: TransactionsService injection
grep -n "TransactionsService" backend/src/modules/capital-contributions/application/capital-contributions.service.ts
# Result: SHOULD SHOW CONSTRUCTOR PARAMETER

# Check: DTO converter called
grep -n "toCreateTransactionDto" backend/src/modules/capital-contributions/application/capital-contributions.service.ts
# Result: SHOULD SHOW USAGE IN createTransaction CALL
```

**Expected Output**:
- âœ… NO grep results for transactionRepository.save()
- âœ… TransactionsService in constructor
- âœ… DTO conversion and delegation

---

### âœ… CashDepositsService
**Refactoring Status**: COMPLETED

- [x] Removed `transactionRepository.save()` direct calls
- [x] Removed `buildDocumentNumber()` method
- [x] Removed `metadata.cashDeposit` flag creation
- [x] Added `TransactionsService` injection
- [x] Added `CreateCashDepositDto.toCreateTransactionDto()` conversion
- [x] Delegates to `TransactionsService.createTransaction()`
- [x] Expected: CASH_DEPOSIT transaction + 2 asientos + V2 validation (saldo caja)

**Verification Command**:
```bash
grep -n "transactionRepository.save\|buildDocumentNumber" backend/src/modules/cash-deposits/application/cash-deposits.service.ts
# Result: SHOULD BE EMPTY

grep -n "TransactionsService\|toCreateTransactionDto" backend/src/modules/cash-deposits/application/cash-deposits.service.ts
# Result: SHOULD SHOW INJECTIONS AND USAGE
```

---

### âœ… BankTransfersService
**Refactoring Status**: COMPLETED

- [x] Removed `transactionRepository.save()` direct calls
- [x] Removed `buildDocumentNumber()` method
- [x] Removed `metadata.bankToCashTransfer` flag creation
- [x] Added `TransactionsService` injection
- [x] Added `CreateBankTransferDto.toCreateTransactionDto()` conversion
- [x] Delegates to `TransactionsService.createTransaction()`
- [x] Expected: PAYMENT_OUT transaction + 2 asientos + V1 validation (saldo banco)

---

### âœ… BankWithdrawalsService
**Refactoring Status**: COMPLETED

- [x] Removed `transactionRepository.save()` direct calls
- [x] Removed `buildDocumentNumber()` method
- [x] Removed `metadata.bankWithdrawalToShareholder` flag creation
- [x] Added `TransactionsService` injection
- [x] Added `CreateBankWithdrawalDto.toCreateTransactionDto()` conversion
- [x] Delegates to `TransactionsService.createTransaction()`
- [x] Expected: BANK_WITHDRAWAL_TO_SHAREHOLDER transaction + 2 asientos + V1 validation

---

### âœ… PaymentsService
**Refactoring Status**: COMPLETED

- [x] Removed `createPaymentTransaction()` direct save
- [x] Updated comments to reflect delegation pattern
- [x] Added injection of `TransactionsService` and `LedgerEntriesService`
- [x] Expected: PAYMENT_IN transactions + asientos + V4 validation (saldo cliente)

---

### ðŸŸ¡ CashSessionsService
**Refactoring Status**: PENDING

- [ ] Extract `CashSessionCoreService` (session management only)
- [ ] Extract `SalesFromSessionService` (sale creation)
- [ ] Extract `SessionInventoryService` (stock management)
- [ ] Remove 786-line monolithic service
- [ ] All transaction creation delegates to `TransactionsService.createTransaction()`
- [ ] Expected: CASH_SESSION_OPENING, CASH_SESSION_CLOSING, SALE + asientos

**Priority**: HIGH (120+ lines of complexity to refactor)

**See**: [CASHSESSION_REFACTORING_GUIDE.md](./CASHSESSION_REFACTORING_GUIDE.md)

---

### ðŸŸ¡ SalesService
**Refactoring Status**: PENDING

- [ ] Check if creates SALE transactions directly
- [ ] If yes: Replace `transactionRepository.save()` with `TransactionsService.createTransaction()`
- [ ] Expected: SALE transaction + line items + asientos + V5-V7 validation

**Verification Command**:
```bash
grep -n "transactionRepository.save\|SALE" backend/src/modules/sales/application/sales.service.ts
# Check if creates transactions directly
```

---

### ðŸŸ¡ PurchasesService
**Refactoring Status**: PENDING

- [ ] Check if creates PURCHASE transactions directly
- [ ] If yes: Replace `transactionRepository.save()` with `TransactionsService.createTransaction()`
- [ ] Expected: PURCHASE transaction + line items + asientos + V6-V7 validation

---

### ðŸŸ¡ Other Services (20+ identified)

Use this grep command to find ALL services that create transactions directly:

```bash
# Find all *.service.ts files in /backend/src/modules
find backend/src/modules -name "*.service.ts" -type f

# For each, check if it calls transactionRepository.save() or creates Transaction directly:
for file in $(find backend/src/modules -name "*.service.ts" -type f); do
  if grep -q "transactionRepository.save\|new Transaction\|this.transactionRepository.create" "$file"; then
    echo "âŒ DIRECT CREATE: $file"
  fi
done
```

**Expected Result**: Only `TransactionsService` and `LedgerEntriesService` should appear.

---

## Integration Test Checklist

### Test Setup
```bash
cd backend
npm run test -- --testPathPattern="transactions|ledger-entries"
```

### Happy Path Tests

#### [TEST-001] Create PAYMENT_IN (Capital Contribution)
- **Given**: User calls `CapitalContributionsService.create()`
- **When**: With valid shareholderId, bankAccountKey, amount
- **Then**:
  - [x] Transaction created with type PAYMENT_IN
  - [x] DocumentNumber generated and unique
  - [x] Status = CONFIRMED
  - [x] 2 LedgerEntry records created (debit bank, credit equity)
  - [x] Saldo banco updated correctly
  - [x] Metadata includes `capitalContribution=true`
  - [x] Audit trail recorded
  - [x] Response includes `asientos` array

**Test Code** (pseudo):
```typescript
const result = await capitalContributionsService.create({
  shareholderId: 'shareholder-1',
  bankAccountKey: 'bank-account-1',
  amount: 1000,
});

expect(result.success).toBe(true);
expect(result.data.asientos).toHaveLength(2);
expect(result.data.asientos[0].debit).toBe(1000);
expect(result.data.asientos[1].credit).toBe(1000);
```

#### [TEST-002] Create CASH_DEPOSIT
- **Given**: User calls `CashDepositsService.create()`
- **When**: With valid bankAccountKey, amount
- **Then**:
  - [x] Transaction created with type CASH_DEPOSIT
  - [x] 2 LedgerEntry records created (debit cash, credit bank)
  - [x] Saldo caja increased
  - [x] Saldo banco decreased
  - [x] V1 validation (saldo banco) passed
  - [x] V2 validation (saldo caja) enforced

#### [TEST-003] Create PAYMENT_OUT (Bank Transfer)
- **Given**: User calls `BankTransfersService.create()`
- **When**: With valid bankAccountKey, amount
- **Then**:
  - [x] Transaction created with type PAYMENT_OUT
  - [x] 2 LedgerEntry records created (debit expense, credit bank)
  - [x] Saldo banco decreased
  - [x] V1 validation enforced (no saldo banco â†’ rejection)

#### [TEST-004] Create PAYMENT_IN with Insufficient Balance (Negative Test)
- **Given**: Customer owes $500, system balance = $300
- **When**: `PaymentsService.createMultiplePayments()` for $400
- **Then**:
  - [x] V4 validation (saldo cliente) rejects with message
  - [x] Transaction NOT created
  - [x] NO LedgerEntry created
  - [x] Error response includes validation reason

### Validation Gate Tests

#### [VALIDATION-V1] Saldo Banco Check
```typescript
// Setup: Bank account has $100
// Test 1: PAYMENT_OUT $50 â†’ PASS
// Test 2: PAYMENT_OUT $150 â†’ FAIL (V1 rejects)
// Test 3: CASH_DEPOSIT $200 (from external) â†’ PASS
// Test 4: PAYMENT_OUT $300 â†’ FAIL
```

#### [VALIDATION-V2] Saldo Caja Check
```typescript
// Setup: Cash box has $100
// Test 1: CASH_WITHDRAW $50 â†’ PASS
// Test 2: CASH_WITHDRAW $150 â†’ FAIL (V2 rejects)
// Test 3: CASH_DEPOSIT $200 (from bank) â†’ PASS
```

#### [VALIDATION-V4] Deuda Cliente Check
```typescript
// Setup: Customer owes $0 (credit limit $500)
// Sale 1: $300 on credit â†’ PASS (V5 checks availability)
// Payment 1: $100 (partial) â†’ PASS
// Payment 2: $250 (more than owed $200) â†’ FAIL (V4 rejects)
```

---

## Code Review Checklist

### For Each Refactored Service

- [ ] **No Direct Save**: `transactionRepository.save()` not called outside `TransactionsService`
- [ ] **TransactionsService Injected**: Constructor includes `private transactionsService: TransactionsService`
- [ ] **DTO Conversion**: Service imports and uses `Create[Type]Dto.toCreateTransactionDto()`
- [ ] **Error Handling**: `try/catch` wrapping `transactionsService.createTransaction()` call
- [ ] **Response Structure**: Returns object with `success`, `data`, and optionally `asientos`
- [ ] **Logging**: Major operations logged (create attempt, success, failure)
- [ ] **Type Safety**: No `any` types; proper TypeScript typing throughout
- [ ] **Comments**: Explains why delegation pattern (references accounting engine)

---

## Database Verification

### Check: Asientos are being generated

```sql
-- For each transaction created via new services, verify LedgerEntry exists

-- Count transactions by type (last 24 hours)
SELECT 
  transaction_type, 
  COUNT(*) as tx_count 
FROM transactions 
WHERE created_at > NOW() - INTERVAL 1 DAY 
GROUP BY transaction_type;

-- Count ledger entries (should match)
SELECT 
  transaction_id, 
  COUNT(*) as entry_count 
FROM ledger_entries 
WHERE created_at > NOW() - INTERVAL 1 DAY 
GROUP BY transaction_id 
HAVING entry_count = 0;  -- This should be EMPTY

-- Verify balance consistency
SELECT 
  account_id,
  SUM(CASE WHEN entry_type = 'DEBIT' THEN amount ELSE -amount END) as balance
FROM ledger_entries
WHERE entry_date <= NOW()
GROUP BY account_id;
  -- All balances should be >= 0 (conservative accounting)
```

### Check: No orphaned transactions (with no ledger entries)

```sql
SELECT 
  t.id, 
  t.document_number, 
  t.transaction_type,
  COUNT(le.id) as entry_count
FROM transactions t
LEFT JOIN ledger_entries le ON t.id = le.transaction_id
WHERE t.created_at > NOW() - INTERVAL 24 HOUR
GROUP BY t.id
HAVING entry_count = 0;
  -- This should return EMPTY RESULT
```

---

## Performance Checklist

- [ ] **No N+1 Queries**: Use `@Eager()` or `leftJoinAndSelect()` for related data
- [ ] **Atomic Transactions**: All multi-step operations in single `DataSource.transaction()`
- [ ] **Batch Operations**: Bulk creates use `saveMany()` not loop of save
- [ ] **Index Coverage**: Queries on `transaction_id`, `account_id`, `person_id` use indexes
- [ ] **Query Timeout**: Long-running queries timeout after 30s (configurable)

---

## Rollout Validation

### Staging Environment Tests (Before Production)

1. [ ] Deploy refactored services to staging
2. [ ] Run full E2E test suite (1+ hour)
3. [ ] Run migration scripts (if any)
4. [ ] Verify all 10 validation gates (V1-V10) work
5. [ ] Load test: 1000 concurrent transactions
6. [ ] Verify no orphaned transactions in DB
7. [ ] Verify audit trail complete
8. [ ] Verify response times acceptable (<500ms for 95th percentile)

### Production Monitoring (First 24 Hours)

1. [ ] Monitor error rates (should match baseline)
2. [ ] Monitor validation rejection rates (should be low but present)
3. [ ] Monitor ledger entry generation success rate (should be 99%+)
4. [ ] Monitor response times (should not increase)
5. [ ] Monitor database transaction log (no long locks)
6. [ ] Monitor audit trail insertion rate
7. [ ] Random sampling: verify asientos match transactions

---

## Debugging Guide

### Issue: Transaction created but no LedgerEntry

**Root Cause**: `LedgerEntriesService.generateEntriesForTransaction()` not called or failed silently

**Debug Steps**:
```typescript
// 1. Check TransactionsService.createTransaction() calls ledger service
const result = await transactionsService.createTransaction(dto);
console.log('Result metadata:', result.metadata);
// Should show: ledgerEntriesGenerated: [...], validationsPassed: [...]

// 2. Check LedgerEntriesService for error
SELECT * FROM ledger_entries WHERE transaction_id = ?;
// If EMPTY and transaction exists â†’ generator failed

// 3. Check audit log
SELECT * FROM audit_log WHERE transaction_id = ? ORDER BY created_at DESC;
// Look for LEDGER_GENERATION_ERROR entry
```

### Issue: Validation gate V1 not rejecting insufficient balance

**Root Cause**: `getAccountBalance()` query wrong or not called

**Debug Steps**:
```typescript
// 1. Verify query logic
const balance = await ledgerEntriesService.getAccountBalance(accountId, beforeDate);
console.log('Current balance:', balance);  // Should be < 0 if insufficient

// 2. Check account balance manually
SELECT 
  SUM(CASE WHEN entry_type = 'DEBIT' THEN amount ELSE -amount END) as balance
FROM ledger_entries
WHERE account_id = ? AND entry_date <= ?;

// 3. Look for validation gate in logs
SELECT * FROM audit_log WHERE event = 'VALIDATION_GATE_V1' AND transaction_id = ?;
// Should show rejection reason
```

### Issue: DocumentNumber duplicates

**Root Cause**: `generateDocumentNumber()` not called or not unique

**Debug Steps**:
```sql
-- Find duplicates
SELECT document_number, COUNT(*) as cnt
FROM transactions
GROUP BY document_number
HAVING cnt > 1
LIMIT 10;

-- Check timestamp distribution
SELECT 
  DATE_FORMAT(created_at, '%Y-%m-%d %H:%i') as minute,
  COUNT(*) as count,
  COUNT(DISTINCT document_number) as unique_docs
FROM transactions
WHERE created_at > NOW() - INTERVAL 1 HOUR
GROUP BY DATE_FORMAT(created_at, '%Y-%m-%d %H:%i')
ORDER BY minute DESC;
-- If count > unique_docs â†’ duplicates in that minute
```

---

## Success Criteria (Final Validation)

### Code Quality
- âœ… 0 services using `transactionRepository.save()` directly (outside TransactionsService)
- âœ… 0 services creating `buildDocumentNumber()` individually
- âœ… 0 services with metadata flags that aren't consumed
- âœ… 100% of services have error handling around ledger generation
- âœ… 95%+ test coverage for core services

### Functional
- âœ… Every transaction type has auto-generated asientos
- âœ… All V1-V10 validation gates enforced
- âœ… No orphaned transactions (unmatched to ledger entries)
- âœ… No duplicate document numbers
- âœ… All errors logged to audit trail

### Performance
- âœ… Transaction creation: <500ms (95th percentile)
- âœ… Ledger entry generation: <200ms (95th percentile)
- âœ… No N+1 queries
- âœ… No long-running transactions (>5s)

### Operational
- âœ… Monitoring alerts configured for ledger generation failures
- âœ… Rollback procedure documented and tested
- âœ… Data migration completed (if needed)
- âœ… Runbook updated with new service topology

---

## Resources

- [Main Refactoring Progress](./REFACTORING_PROGRESS_COHERENCE.md)
- [CashSessionsService Refactoring Guide](./CASHSESSION_REFACTORING_GUIDE.md)
- [Accounting Rules Specification](./docs/accounting-rules.md)
- [LedgerEntriesService Documentation](./src/modules/ledger-entries/README.md)
- [TransactionsService Documentation](./src/modules/transactions/README.md)

---

**Last Updated**: [Date]
**Checklist Status**: Phase 2.1 Complete (Banking Services) | Phase 2.2 Pending (Complex Services)
**Target Completion**: 3-5 days
